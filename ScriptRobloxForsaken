local Players=game:GetService("Players")
local RunService=game:GetService("RunService")
local Lighting=game:GetService("Lighting")
local Workspace=game:GetService("Workspace")
local StarterGui=game:GetService("StarterGui")
local UserInputService=game:GetService("UserInputService")
local player=Players.LocalPlayer

player:WaitForChild("PlayerGui")
StarterGui:SetCore("SendNotification",{Title="Info",Text="Script Work!",Duration=5})

local stopAll=false
local enabledSurvivors=true
local enabledLoot=true
local enabledKillers=true
local enabledRotate=true
local currentTime=14
local boxes={}
local guiVisible=true

local function addBox(part,color,transparency)
 if part and not boxes[part] then
  local box=Instance.new("BoxHandleAdornment")
  box.Name="PartBox"
  box.Size=part.Size
  box.Adornee=part
  box.AlwaysOnTop=true
  box.ZIndex=5
  box.Color3=color
  box.Transparency=transparency
  box.Parent=part
  boxes[part]=box
 end
end

local function removeBox(part)
 if boxes[part] then
  boxes[part]:Destroy()
  boxes[part]=nil
 end
end

local function updateCharacterBoxes(char)
 if stopAll or not char then return end
 if char == player.Character then return end
 for _,part in ipairs(char:GetDescendants()) do
  if part:IsA("BasePart") then
   if enabledSurvivors and char.Parent and char.Parent.Name=="Survivors" then
    addBox(part,Color3.fromRGB(255,0,0),0.9)
   elseif enabledKillers and char.Parent and char.Parent.Name=="Killers" then
    addBox(part,Color3.fromRGB(0,0,255),0.85)
   else
    removeBox(part)
   end
  end
 end
end

local function updateToolsAndPizza(obj)
 if stopAll or not enabledLoot then return end
 if obj:IsA("Tool") and (obj.Name=="BloxyCola" or obj.Name=="Medkit") then
  for _,part in ipairs(obj:GetDescendants()) do
   if part:IsA("BasePart") then addBox(part,Color3.fromRGB(0,255,0),0.5) end
  end
 elseif obj:IsA("BasePart") and obj.Name=="Pizza" then
  addBox(obj,Color3.fromRGB(0,255,0),0.5)
 end
end

local function scanWorkspace(folder)
 for _,obj in ipairs(folder:GetDescendants()) do updateToolsAndPizza(obj) end
end

local function refreshAllBoxes()
 for part,_ in pairs(boxes) do removeBox(part) end
 for _,plr in pairs(Players:GetPlayers()) do
  if plr.Character then updateCharacterBoxes(plr.Character) end
 end
 scanWorkspace(Workspace)
end

Players.PlayerAdded:Connect(function(plr)
 plr.CharacterAdded:Connect(function(char)
  char:WaitForChild("HumanoidRootPart")
  updateCharacterBoxes(char)
 end)
end)

for _,plr in pairs(Players:GetPlayers()) do
 plr.CharacterAdded:Connect(function(char)
  char:WaitForChild("HumanoidRootPart")
  updateCharacterBoxes(char)
 end)
 if plr.Character then updateCharacterBoxes(plr.Character) end
end

scanWorkspace(Workspace)
Workspace.DescendantAdded:Connect(updateToolsAndPizza)

RunService.RenderStepped:Connect(function()
 if stopAll then return end
 if not player.Character then return end
 local humanoid=player.Character:FindFirstChildOfClass("Humanoid")
 local root=player.Character:FindFirstChild("HumanoidRootPart")
 if not humanoid or not root then return end
 if humanoid.Health<=0 then return end
 if enabledRotate then
  local closest=nil
  local distMin=math.huge
  for _,plr in pairs(Players:GetPlayers()) do
   if plr~=player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChildOfClass("Humanoid") then
    local target=plr.Character.HumanoidRootPart
    local dist=(target.Position-root.Position).Magnitude
    if dist<distMin then distMin=dist; closest=target end
   end
  end
  if closest then
   local pos=root.Position
   local dir=(closest.Position-pos).Unit
   local flat=Vector3.new(dir.X,0,dir.Z)
   if flat.Magnitude>0 then root.CFrame=CFrame.lookAt(pos,pos+flat) end
  end
 end
 for _,v in pairs(Lighting:GetChildren()) do if v:IsA("Sky") then v:Destroy() end end
 Lighting.TimeOfDay=string.format("%02d:00:00",currentTime)
end)

local function makeDraggable(frame,handle,callback)
 local dragging=false
 local dragInput
 local dragStart
 local startPos
 local moved=false
 local function update(input)
  local delta=input.Position-dragStart
  if math.abs(delta.X)>2 or math.abs(delta.Y)>2 then
   moved=true
  end
  frame.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X,startPos.Y.Scale,startPos.Y.Offset+delta.Y)
 end
 handle.InputBegan:Connect(function(input)
  if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
   dragging=true
   dragStart=input.Position
   startPos=frame.Position
   moved=false
   input.Changed:Connect(function()
    if input.UserInputState==Enum.UserInputState.End then
     dragging=false
     if not moved then
      callback()
     end
    end
   end)
  end
 end)
 handle.InputChanged:Connect(function(input)
  if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
   dragInput=input
  end
 end)
 UserInputService.InputChanged:Connect(function(input)
  if input==dragInput and dragging then
   update(input)
  end
 end)
end

local function createGUI()
 local ScreenGui=Instance.new("ScreenGui",player.PlayerGui)
 ScreenGui.ResetOnSpawn=false

 local mainFrame=Instance.new("Frame",ScreenGui)
 mainFrame.Size=UDim2.new(0,240,0,250)
 mainFrame.Position=UDim2.new(0,10,0.5,-125)
 mainFrame.BackgroundColor3=Color3.fromRGB(0,0,0)
 mainFrame.BackgroundTransparency=0.35
 mainFrame.BorderSizePixel=0

 local topFrame=Instance.new("Frame",mainFrame)
 topFrame.Size=UDim2.new(1,0,0,40)
 topFrame.BackgroundTransparency=1

 local toggleBtn=Instance.new("TextButton",topFrame)
 toggleBtn.Size=UDim2.new(0.8,0,1,0)
 toggleBtn.Position=UDim2.new(0,0,0,0)
 toggleBtn.Text="Toggle Menu"
 toggleBtn.BackgroundColor3=Color3.fromRGB(30,30,30)
 toggleBtn.TextColor3=Color3.fromRGB(255,255,255)
 toggleBtn.Font=Enum.Font.GothamBold
 toggleBtn.TextSize=16

 local closeBtn=Instance.new("TextButton",topFrame)
 closeBtn.Size=UDim2.new(0.2,0,1,0)
 closeBtn.Position=UDim2.new(0.8,0,0,0)
 closeBtn.Text="X"
 closeBtn.BackgroundColor3=Color3.fromRGB(200,50,50)
 closeBtn.TextColor3=Color3.fromRGB(255,255,255)
 closeBtn.Font=Enum.Font.GothamBold
 closeBtn.TextSize=14

 local layout=Instance.new("UIListLayout",mainFrame)
 layout.Padding=UDim.new(0,5)
 layout.HorizontalAlignment=Enum.HorizontalAlignment.Center
 layout.VerticalAlignment=Enum.VerticalAlignment.Top
 layout.SortOrder=Enum.SortOrder.LayoutOrder

 local confirmFrame=Instance.new("Frame",ScreenGui)
 confirmFrame.Size=UDim2.new(0,250,0,120)
 confirmFrame.Position=UDim2.new(0.5,-125,0.5,-60)
 confirmFrame.BackgroundColor3=Color3.fromRGB(25,25,25)
 confirmFrame.Visible=false

 local confirmText=Instance.new("TextLabel",confirmFrame)
 confirmText.Size=UDim2.new(1,0,0,50)
 confirmText.Position=UDim2.new(0,0,0,10)
 confirmText.Text="Are You Sure Cancel This GUI?"
 confirmText.TextColor3=Color3.fromRGB(255,255,255)
 confirmText.BackgroundTransparency=1
 confirmText.TextSize=18
 confirmText.Font=Enum.Font.GothamBold

 local yes=Instance.new("TextButton",confirmFrame)
 yes.Size=UDim2.new(0.45,0,0,40)
 yes.Position=UDim2.new(0.05,0,0.6,0)
 yes.Text="Yes"
 yes.BackgroundColor3=Color3.fromRGB(200,50,50)
 yes.TextColor3=Color3.fromRGB(255,255,255)
 yes.Font=Enum.Font.GothamBold
 yes.TextSize=16

 local no=Instance.new("TextButton",confirmFrame)
 no.Size=UDim2.new(0.45,0,0,40)
 no.Position=UDim2.new(0.5,0,0.6,0)
 no.Text="No"
 no.BackgroundColor3=Color3.fromRGB(50,200,50)
 no.TextColor3=Color3.fromRGB(255,255,255)
 no.Font=Enum.Font.GothamBold
 no.TextSize=16

 closeBtn.MouseButton1Click:Connect(function() confirmFrame.Visible=true end)
 yes.MouseButton1Click:Connect(function()
  stopAll=true
  for part,_ in pairs(boxes) do removeBox(part) end
  mainFrame:Destroy()
  confirmFrame:Destroy()
 end)
 no.MouseButton1Click:Connect(function() confirmFrame.Visible=false end)

 local function makeToggle(name,default,callback)
  local btn=Instance.new("TextButton",mainFrame)
  btn.Size=UDim2.new(1,-10,0,30)
  btn.Font=Enum.Font.GothamBold
  btn.BackgroundColor3=Color3.fromRGB(30,30,30)
  btn.RichText=true
  local state=default
  local function updateText()
   local color=state and "0,255,0" or "255,0,0"
   btn.Text=name..': <font color="rgb('..color..')">'..(state and "ON" or "OFF")..'</font>'
   btn.TextColor3=Color3.fromRGB(255,255,255)
   btn.TextSize=16
  end
  updateText()
  btn.MouseButton1Click:Connect(function()
   state=not state
   updateText()
   callback(state)
   refreshAllBoxes()
  end)
 end

 makeToggle("Survivors ESP",enabledSurvivors,function(s) enabledSurvivors=s end)
 makeToggle("Item ESP",enabledLoot,function(s) enabledLoot=s end)
 makeToggle("Killers ESP",enabledKillers,function(s) enabledKillers=s end)
 makeToggle("Auto Lock",enabledRotate,function(s) enabledRotate=s end)

 local timeBtn=Instance.new("TextButton",mainFrame)
 timeBtn.Size=UDim2.new(1,-10,0,30)
 timeBtn.Text="Time of Day: "..currentTime
 timeBtn.TextColor3=Color3.fromRGB(255,255,255)
 timeBtn.BackgroundColor3=Color3.fromRGB(30,30,30)
 timeBtn.Font=Enum.Font.GothamBold
 timeBtn.TextSize=16
 timeBtn.MouseButton1Click:Connect(function()
  currentTime=currentTime+1
  if currentTime>23 then currentTime=0 end
  timeBtn.Text="Time of Day: "..currentTime
 end)

 makeDraggable(mainFrame,toggleBtn,function()
  guiVisible=not guiVisible
  for i,v in ipairs(mainFrame:GetChildren()) do
   if v:IsA("TextButton") and v~=toggleBtn and v~=closeBtn then
    v.Visible=guiVisible
   end
  end
  mainFrame.BackgroundTransparency=guiVisible and 0.35 or 1
 end)
end

createGUI()
Players.LocalPlayer.CharacterAdded:Connect(function()
 refreshAllBoxes()
end)
